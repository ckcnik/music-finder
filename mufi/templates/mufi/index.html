{% load staticfiles %}
<script src="{% static 'mufi/js/jquery.js' %}"></script>
<script src="{% static 'mufi/js/jquery.cookie.js' %}"></script>
<link rel="stylesheet" type="text/css" href="{% static 'mufi/style.css' %}" />

{# Load the tag library #}
{% load bootstrap3 %}

{# Load CSS and JavaScript #}
{% bootstrap_css %}
{% bootstrap_javascript %}

{# Display django.contrib.messages as Bootstrap alerts #}
{% bootstrap_messages %}

<div class="container-fluid">
    <div class="row">
        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12 text-center"></div>
    </div>
    <div class="row">
        <div class="col-xs-12 col-sm-12 col-md-3 col-lg-4 text-center"></div>
        <div class="col-xs-12 col-sm-12 col-md-6 col-lg-4">
            <div class="well well-sm">
                <form id='youtube-form' action="/" method="post">
                    {% csrf_token %}
                    {% bootstrap_field form.url layout='inline' %}
                    {% bootstrap_field form.time_start layout='inline' %}
                    <div class="form-group text-center">
                        <button id='submit-button' type="submit" class="btn btn-primary">
                            {% bootstrap_icon "star" %} Определить
                        </button>
                    </div>
                </form>
                <img src="{% static 'mufi/images/loader.gif' %}" class="loader">
                <div class="alert alert-success" id="parsing-result"></div>
            </div>
        </div>
        <div class="col-xs-12 col-sm-12 col-md-3 col-lg-4 text-center"></div>
    </div>
    <div class="row">
        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12 text-center"></div>
    </div>
</div>

<script type="text/javascript">
$(document).ready(function() {
    var csrftoken = $.cookie('csrftoken');
    var timerId = 0;
    // Submit post on submit
    $('#submit-button').on('click', function(event){
        $('img.loader').show();
        event.preventDefault();
        console.log("form submitted!")  // sanity check
        var frm = $('#youtube-form');
        $.ajax({
            type: frm.attr('method'),
            url: frm.attr('action'),
            data: frm.serialize(),
            success: function (data) {
                if (parseInt(data) != 0) {
                    console.log("start checker");
                    // начать повторы с интервалом 2 сек
                    timerId = setInterval(function () {
                        checkerState(data);
                    }, 2000);

                    // через 2 мин остановить повторы
                    setTimeout(function () {
                        clearInterval(timerId);
                        console.log("stop checker");
                    }, 240000);
                }
            },
            error: function(data) {
                $("#parsing-result").html("Something went wrong!");
            }
        });
        return false;
    });

    function checkerState(videoId) {
        console.log("check");
        $.ajax({
            beforeSend: function(xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            },
            type: 'POST',
            url: 'checker_state',
            data: {'videoId': videoId},
            success: function (data) {
                var response = $.parseJSON( data );
                if (response.status == 'ok') {
                    $("#parsing-result").html(data);
                    $('#parsing-result').show();
                    $('img.loader').hide();
                    clearInterval(timerId);
                }
            },
            error: function(data) {
                $("#parsing-result").html("Something went wrong!");
            }
        });
    }

    function csrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }
});
</script>